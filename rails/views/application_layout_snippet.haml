-# ============================================================
-# MASTODON MATRIX THEME - Layout Snippet
-# Add this to your app/views/layouts/application.html.haml
-# ============================================================

-# 1. Add this in the <head> section (after existing meta tags):

    -# Errordon: Matrix color configuration (for JavaScript)
    - matrix_color = defined?(Errordon::MATRIX_COLOR) ? Errordon::MATRIX_COLOR : 'green'
    %meta{ name: 'errordon-matrix-color', content: matrix_color }/

-# 2. Modify the <body> tag:

  -# Errordon: Add theme-matrix class and color class if enabled
  - matrix_enabled = ENV['ERRORDON_MATRIX_THEME_ENABLED'] == 'true' || (defined?(Errordon::THEME) && Errordon::THEME == 'matrix')
  - matrix_color = defined?(Errordon::MATRIX_COLOR) ? Errordon::MATRIX_COLOR : 'green'
  - body_class_list = body_classes
  - body_class_list = "#{body_class_list} theme-matrix matrix-color-#{matrix_color}" if matrix_enabled
  %body{ class: body_class_list, 'data-matrix-color': matrix_color }

-# 3. Add this right after opening <body> tag:

    -# Errordon Matrix Theme - Rain Background Canvas (always present, JS controls visibility)
    %canvas#matrixRainCanvas{ style: 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none;' }
    
    -# Errordon Matrix Theme - Initialization (Web Worker based for smooth scrolling)
    :javascript
      // Errordon Matrix Rain - Web Worker version (doesn't freeze on scroll)
      (function() {
        document.body.classList.add('theme-matrix');
        
        var canvas = document.getElementById('matrixRainCanvas');
        if (!canvas) return;
        
        var ctx = canvas.getContext('2d');
        var width, height, columns, drops;
        
        function initCanvas() {
          width = canvas.width = window.innerWidth;
          height = canvas.height = window.innerHeight;
          columns = Math.floor(width / 14);
          drops = [];
          for (var i = 0; i < columns; i++) {
            drops[i] = Math.random() * -100;
          }
        }
        
        window.addEventListener('resize', initCanvas);
        initCanvas();
        
        var matrixColor = document.body.dataset.matrixColor || 'green';
        var colors = { green: '#00ff00', red: '#ff0000', blue: '#00bfff', purple: '#bf00ff' };
        var rainColor = colors[matrixColor] || '#00ff00';
        
        var chars = 'アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワヲン0123456789';
        
        function draw() {
          ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
          ctx.fillRect(0, 0, width, height);
          ctx.fillStyle = rainColor;
          ctx.font = '14px monospace';
          
          for (var i = 0; i < drops.length; i++) {
            var text = chars[Math.floor(Math.random() * chars.length)];
            ctx.fillText(text, i * 14, drops[i] * 14);
            
            if (drops[i] * 14 > height && Math.random() > 0.975) {
              drops[i] = 0;
            }
            drops[i]++;
          }
        }
        
        setInterval(draw, 33);
      })();
